---
title: "Meterological Lake Comparison"
author: "Cady B"
params:
  lake_name: "Lake Rotorua"
  lat: -38.114908
  lon: 176.316662
  buffer_km: 10
  lake_id: "rotorua"
  reference: "Airport_1770"
  targets: ["ERA5", "Buoy", "Town_40177", "VCS_On"]
  vars: ["Temp_C", "Precip_mm", "Wind_Spd_ms", "RadSWD_Wm2"]
---

![](images/update.png){fig-align="center"}


When it comes to limnological science, precipitation, wind and temperature are unavoidable physcal forms to consider. Selecting the appropriate dataset or source can play a critical role in both physical and biological results. However, it is often difficult to know which dataset or source is best to apply. Therefore, by critically comparing and analysing different data sources for a given location, we can gather more confidence in what data set and which variable is best to use, and when it is best to use it.

## Project description

This project aims to take meteorological data in close proximity from different sources (e.g. stations, gridded, and reanalysis) and evaluate their validity across variables and time.

It assesses four main meteorological parameters (precipitation, wind, radiation, temperature) for accuracy, stability and usability. This was developed for the use of limnologists with the purpose of selecting data sources for differing projects and attempts to answer the question "what data to use and when?". The data sources used are [Limnotrack](https://limnotrack.com/) Buoy in-situ, NIWA virtual climate station network ([VCSN](https://data.niwa.co.nz/products/vcsn-timeseries)), ERA5 ([European Centre for Medium-Range Weather Forecasts (ECMWF) reanalysis v5](https://www.ecmwf.int/en/forecasts)) statlite data and NIWAs ([Earth Sciences New Zealand](https://www.earthsciences.nz/)) observational climate data .

Lake Rotorua, North Island, New Zealand is used as a worked example throughout.

## Guide for tabs

This project takes your though the overview of the project which addresses:

1.  Overview: Data sources and the project outputs so the reader can understand what they will get out of the process.

2.  Methods: Outlining the steps taken to prepare, align, and compare the metrological datasets.

3.  Time series: Which shows time series plots to visualise data stability and alignment.

<!-- -->

4.  Metrics and stats: Which shows the statistical/quantitative diagnostics outlined in the overview.

5.  Seasonal and event behaviour: Which shows seasonality/climatology performance and dataset agreement during events.

6.  Rotorua demo: A demonstration project output with Lake Rotorua as the example lake.

7.  Reproducibility: Talks through the reusability of this project when accessing different lakes around New Zealand.

Desision of what data sets to use will depend on intended outcome. The objective tab will show outputs where the reader can decide how to use the project to answer their questions around meteorological data sources. Rotorua Demo addresses what datasets would be best to use and what for the Lake Rotorua.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
#| echo: false
#| message: false
#| warning: false
library(glue)
library(htmltools)
library(gt)
library(plotly)
library(here)
library(tidyverse)
library(lubridate)
library(slider)
library(here)
library(reactable)

# ---- Source scripts (from project root) ----
source(here("scripts", "01_metrics_helpers.R"))
source(here("scripts", "03_analysis_helpers.R"))
source(here("scripts", "04_analysis_plotting.R"))
```

```{r}
#| echo: false
# --- Load processed daily data for Rotorua (project-standard) ---
file_map <- list(
  ERA5         = here("data/processed/rotorua_era5_daily.csv"),
  Buoy         = here("data/processed/rotorua_buoy_daily.csv"),
  Town_40177   = here("data/processed/rotorua_town_40177_daily.csv"),
  VCS_On       = here("data/processed/rotorua_vcs_on_daily.csv"),
  Airport_1770 = here("data/processed/rotorua_airport_1770_daily.csv")
)

read_from_map <- function(name) {
  readr::read_csv(file_map[[name]], show_col_types = FALSE) |>
    mutate(Date = as.Date(Date))
}

ref_name <- params$reference
target_names <- params$targets

ref_df <- read_from_map(ref_name)
targets_list <- setNames(lapply(target_names, read_from_map), target_names)

# keep only variables present in reference and every target to avoid render errors
vars_requested <- params$vars
vars_available <- Reduce(
  intersect,
  c(list(names(ref_df)), lapply(targets_list, names))
)
vars <- intersect(vars_requested, vars_available)
```

## Data coverage overview

```{r}
coverage <- bind_rows(
  Reference = ref_df,
  !!!targets_list,
  .id = "Dataset"
) |>
  summarise(
    first_date = min(Date, na.rm = TRUE),
    last_date  = max(Date, na.rm = TRUE),
    n_days     = n(),
    .by = Dataset
  )

reactable(
  coverage,
  sortable = TRUE,
  striped = TRUE,
  pagination = FALSE
)
```

## quick look Metrics table (reference vs targets)

```{r}
metrics_all <- purrr::imap_dfr(
  targets_list,
  ~ metrics_vs_ref(
    ref_df = ref_df,
    target_df = .x,
    target_name = .y,
    vars = vars,
    wet_threshold_mm = 1,
    windy_top_pct = 0.10
  )
)

reactable(
  metrics_all,
  searchable = TRUE,
  sortable = TRUE,
  highlight = TRUE,
  defaultPageSize = 8,
  pagination = TRUE,
  columns = list(
    cor = colDef(format = colFormat(digits = 2)),
    slope = colDef(format = colFormat(digits = 2)),
    intercept = colDef(format = colFormat(digits = 2)),
    mae = colDef(format = colFormat(digits = 2)),
    rmse = colDef(format = colFormat(digits = 2)),
    ccc = colDef(format = colFormat(digits = 2)),
    bias = colDef(format = colFormat(digits = 2)),
    rel_bias = colDef(format = colFormat(digits = 1))
  )
)
```