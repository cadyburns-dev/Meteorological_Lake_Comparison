---
title: "Meterological Lake Comparison"
subtitle: "Rotorua overview"
author: "Cady B"
params:
  lake_name: "Lake Rotorua"
  lat: -38.114908
  lon: 176.316662
  buffer_km: 10
  lake_id: "rotorua"
  reference: "Airport_1770"
  targets: ["ERA5", "Buoy", "Town_40177", "VCS_On"]
  vars: ["Temp_C", "Precip_mm", "Wind_Spd_ms", "RadSWD_Wm2"]
---

![](images/update.png){fig-align="center"}

## Project description

This project aims to take meteorological data in close proximity from different sources and evaluate their validity across variables and time.

It assesses four main meterological parameters (precipitation, wind, radiation, temperature) for accuracy, stability and usability. This was developed for the use of lymnologists with the purpose of selecting data sources for differing projects and attempts to answer the question "what data to use and when?". The data sources used are Limnotrack Buoy in-situ, NIWA virtual climate station network (VCSN), ERA5 statlite data and NIWAs Observational climate data.

Lake Rotorua, North Island, New Zealand is used as a worked example thoughout.

## Guide 

This project takes your though......
Following the logical flow of.....
Desision of what data sets to use will depend on intended outcome. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
#| echo: false
#| message: false
#| warning: false
library(glue)
library(htmltools)
library(gt)
library(plotly)
library(here)
library(tidyverse)
library(lubridate)
library(slider)
library(here)
library(reactable)

# ---- Source scripts (from project root) ----
source(here("scripts", "01_metrics_helpers.R"))
source(here("scripts", "03_analysis_helpers.R"))
source(here("scripts", "04_analysis_plotting.R"))
```

```{r}
#| echo: false
# --- Load processed daily data for Rotorua (project-standard) ---
file_map <- list(
  ERA5         = here("data/processed/rotorua_era5_daily.csv"),
  Buoy         = here("data/processed/rotorua_buoy_daily.csv"),
  Town_40177   = here("data/processed/rotorua_town_40177_daily.csv"),
  VCS_On       = here("data/processed/rotorua_vcs_on_daily.csv"),
  Airport_1770 = here("data/processed/rotorua_airport_1770_daily.csv")
)

read_from_map <- function(name) {
  readr::read_csv(file_map[[name]], show_col_types = FALSE) |>
    mutate(Date = as.Date(Date))
}

ref_name <- params$reference
target_names <- params$targets

ref_df <- read_from_map(ref_name)
targets_list <- setNames(lapply(target_names, read_from_map), target_names)

# keep only variables present in reference and every target to avoid render errors
vars_requested <- params$vars
vars_available <- Reduce(
  intersect,
  c(list(names(ref_df)), lapply(targets_list, names))
)
vars <- intersect(vars_requested, vars_available)
```

## Data coverage

```{r}
coverage <- bind_rows(
  Reference = ref_df,
  !!!targets_list,
  .id = "Dataset"
) |>
  summarise(
    first_date = min(Date, na.rm = TRUE),
    last_date  = max(Date, na.rm = TRUE),
    n_days     = n(),
    .by = Dataset
  )

reactable(
  coverage,
  sortable = TRUE,
  striped = TRUE,
  pagination = FALSE
)
```

## Metrics table (reference vs targets)

```{r}
metrics_all <- purrr::imap_dfr(
  targets_list,
  ~ metrics_vs_ref(
    ref_df = ref_df,
    target_df = .x,
    target_name = .y,
    vars = vars,
    wet_threshold_mm = 1,
    windy_top_pct = 0.10
  )
)

reactable(
  metrics_all,
  searchable = TRUE,
  sortable = TRUE,
  highlight = TRUE,
  defaultPageSize = 8,
  pagination = TRUE,
  columns = list(
    cor = colDef(format = colFormat(digits = 2)),
    slope = colDef(format = colFormat(digits = 2)),
    intercept = colDef(format = colFormat(digits = 2)),
    mae = colDef(format = colFormat(digits = 2)),
    rmse = colDef(format = colFormat(digits = 2)),
    ccc = colDef(format = colFormat(digits = 2)),
    bias = colDef(format = colFormat(digits = 2)),
    rel_bias = colDef(format = colFormat(digits = 1))
  )
)
```

## Time series overlays

```{r}
ts_long <- bind_rows(
  Reference = ref_df,
  !!!targets_list,
  .id = "Dataset"
) |>
  pivot_longer(
    cols = all_of(vars),
    names_to = "Variable",
    values_to = "Value"
  ) |>
  drop_na(Value)

make_ts_plot <- function(var) {
  df <- ts_long |> filter(Variable == var)
  x_rng <- range(df$Date, na.rm = TRUE)
  y_rng <- range(df$Value, na.rm = TRUE)
  p <- ggplot(df, aes(Date, Value, color = Dataset)) +
    geom_line() +
    facet_wrap(~Dataset, ncol = 1, scales = "fixed") +
    coord_cartesian(xlim = x_rng, ylim = y_rng) +
    labs(title = var, x = NULL, y = var) +
    scale_color_manual(
      values = c(
        Airport_1770 = "black",
        ERA5         = "#d95f02",
        Buoy         = "#7570b3",
        Town_40177   = "#f0c400",
        VCS_On       = "#1b9e77"
      )
    ) +
    theme_minimal() +
    theme(legend.position = "none")
  ggplotly(p, tooltip = c("Date", "Value", "Dataset"))
}

lapply(vars, make_ts_plot)
```
