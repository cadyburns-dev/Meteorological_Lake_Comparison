<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Methods – Meterological Lake Comparison</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-cc1d64809b8ed731f92ea1275fe9f05b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="custom.css">
</head>

<body class="floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Meterological Lake Comparison</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Overview.html"> 
<span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./rotorua.html"> 
<span class="menu-text">Rotorua demo</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./methods.html" aria-current="page"> 
<span class="menu-text">Methods</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Behaviour.html"> 
<span class="menu-text">Seasonal and event behaviour</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Results.html"> 
<span class="menu-text">Variable diagnostics</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./metrics_stats.html"> 
<span class="menu-text">Metrics &amp; stats</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Reproducibility.html"> 
<span class="menu-text">Reproducibility</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of Content</h2>
   
  <ul>
  <li><a href="#data-harmonisation-units-and-time-step" id="toc-data-harmonisation-units-and-time-step" class="nav-link active" data-scroll-target="#data-harmonisation-units-and-time-step">Data harmonisation units and time step</a>
  <ul class="collapse">
  <li><a href="#reference-site-justification" id="toc-reference-site-justification" class="nav-link" data-scroll-target="#reference-site-justification">Reference site justification</a></li>
  </ul></li>
  <li><a href="#metrics" id="toc-metrics" class="nav-link" data-scroll-target="#metrics">Metrics</a>
  <ul class="collapse">
  <li><a href="#core-performance-metrics" id="toc-core-performance-metrics" class="nav-link" data-scroll-target="#core-performance-metrics"><strong>Core performance metrics:</strong></a></li>
  <li><a href="#event-agreement-metrics-used-for-precipitation-events" id="toc-event-agreement-metrics-used-for-precipitation-events" class="nav-link" data-scroll-target="#event-agreement-metrics-used-for-precipitation-events"><strong>Event agreement metrics (used for precipitation events):</strong></a></li>
  <li><a href="#seasonal-and-climatology-diagnostics" id="toc-seasonal-and-climatology-diagnostics" class="nav-link" data-scroll-target="#seasonal-and-climatology-diagnostics"><strong>Seasonal and climatology diagnostics:</strong></a></li>
  </ul></li>
  <li><a href="#metric-formulas-paired-daily-values" id="toc-metric-formulas-paired-daily-values" class="nav-link" data-scroll-target="#metric-formulas-paired-daily-values">Metric formulas (paired daily values)</a>
  <ul class="collapse">
  <li><a href="#core-metrics" id="toc-core-metrics" class="nav-link" data-scroll-target="#core-metrics"><strong>Core metrics:</strong></a></li>
  <li><a href="#event-agreement-binary-events-defined-on-the-reference-series-at-a-threshold" id="toc-event-agreement-binary-events-defined-on-the-reference-series-at-a-threshold" class="nav-link" data-scroll-target="#event-agreement-binary-events-defined-on-the-reference-series-at-a-threshold"><strong>Event agreement (binary events defined on the reference series at a threshold):</strong></a></li>
  <li><a href="#seasonal-bias-within-season-s" id="toc-seasonal-bias-within-season-s" class="nav-link" data-scroll-target="#seasonal-bias-within-season-s"><strong>Seasonal bias within season s:</strong></a></li>
  </ul></li>
  <li><a href="#wetwindy-subsets-and-logic" id="toc-wetwindy-subsets-and-logic" class="nav-link" data-scroll-target="#wetwindy-subsets-and-logic">Wet/windy subsets and logic</a></li>
  <li><a href="#data-availability-overlap" id="toc-data-availability-overlap" class="nav-link" data-scroll-target="#data-availability-overlap">Data availability / overlap</a>
  <ul class="collapse">
  <li><a href="#rolling-diagnostics-logic" id="toc-rolling-diagnostics-logic" class="nav-link" data-scroll-target="#rolling-diagnostics-logic">Rolling diagnostics logic</a></li>
  <li><a href="#software-and-packages" id="toc-software-and-packages" class="nav-link" data-scroll-target="#software-and-packages">Software and packages</a></li>
  </ul></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a></li>
  <li><a href="#references-methods-background" id="toc-references-methods-background" class="nav-link" data-scroll-target="#references-methods-background">References (methods background)</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Methods</h1>
<p class="subtitle lead">Data wrangle</p>
</div>



<div class="quarto-title-meta column-page-right">

    
  
    
  </div>
  


</header>


<p>This section documents how the meteorological datasets were prepared, aligned, and compared so the workflow is transparent and repeatable.</p>
<section id="data-harmonisation-units-and-time-step" class="level1">
<h1>Data harmonisation units and time step</h1>
<p>We used four sources: ERA5 reanalysis, buoy in-situ station, airport observations, and NIWA Virtual Climate Station Network (VCSN). All inputs were standardised to a daily time step and common units before any comparisons:</p>
<ul>
<li>Temperature (deg C), wind speed (m/s), and shortwave radiation (W/m^2) were aggregated as daily means; precipitation (mm) as daily totals.</li>
<li>Sub-daily records (e.g., 5-minute buoy, hourly stations) were first converted to UTC, then aggregated with sums for fluxes (precip) and means for state variables (temp, wind, radiation).</li>
<li>Radiation in energy units (MJ/m^2) was converted to power (W/m^2) using <code>Rad_MJm2 * 1e6 / 86400</code> for daily totals and <code>Rad_MJm2 * 1e6 / 3600</code> for hourly values before daily means, matching the reporting interval.</li>
<li>Variable names were standardised to <code>Temp_C</code>, <code>Precip_mm</code>, <code>Wind_Spd_ms</code>, <code>RadSWD_Wm2</code>, plus a <code>Date</code> column for joins.</li>
</ul>
<section id="reference-site-justification" class="level2">
<h2 class="anchored" data-anchor-id="reference-site-justification">Reference site justification</h2>
<p>Airport station data were used as the primary reference because they are maintained, quality-controlled, and co-located near the lake with minimal missingness. All alternative sources (ERA5, VCSN, buoy, Town) were evaluated against this reference over their overlapping dates.</p>
</section>
</section>
<section id="metrics" class="level1">
<h1>Metrics</h1>
<p>Metrics are computed on paired daily values after joining by <code>Date</code> and dropping NA pairs. The target dataset is treated as “sim” and the reference as “obs”.</p>
<section id="core-performance-metrics" class="level2">
<h2 class="anchored" data-anchor-id="core-performance-metrics"><strong>Core performance metrics:</strong></h2>
<ul>
<li><p>Pearson correlation (r) for overall co-variation.</p></li>
<li><p>Linear regression of sim ~ obs to report slope and intercept (scaling and offset bias).</p></li>
<li><p>MAE and RMSE based on error = (sim - obs).</p></li>
<li><p>Lin’s concordance correlation coefficient (CCC) to combine accuracy and precision.</p></li>
<li><p>Bias = mean(sim - obs), and relative bias = bias / mean(obs) * 100 (if mean obs is non-zero).</p></li>
</ul>
</section>
<section id="event-agreement-metrics-used-for-precipitation-events" class="level2">
<h2 class="anchored" data-anchor-id="event-agreement-metrics-used-for-precipitation-events"><strong>Event agreement metrics (used for precipitation events):</strong></h2>
<ul>
<li><p>Events are defined by a threshold on the reference series (default precip &gt;= threshold).</p></li>
<li><p>Counts of hits, misses, false alarms, and correct negatives are computed.</p></li>
<li><p>Skill scores include POD (probability of detection), FAR (false alarm ratio), CSI (critical success index), and bias score.</p></li>
</ul>
</section>
<section id="seasonal-and-climatology-diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="seasonal-and-climatology-diagnostics"><strong>Seasonal and climatology diagnostics:</strong></h2>
<ul>
<li><p>Monthly climatology is summarized with mean and interquartile range (IQR) per dataset.</p></li>
<li><p>Seasonal bias is computed as (target - reference) grouped by season.</p></li>
<li><p>Seasons follow Southern Hemisphere definitions (DJF/MAM/JJA/SON) with an optional warm/cool split.</p></li>
</ul>
<p><strong>Figures use consistent overlap with the reference dates to ensure fair visual comparisons (time series, distributions, scatter).</strong></p>
</section>
</section>
<section id="metric-formulas-paired-daily-values" class="level1">
<h1>Metric formulas (paired daily values)</h1>
<p>Let obs_i be the reference value and sim_i the target value for i = 1..n after pairing by date and dropping NA pairs.</p>
<p>Define error e_i = sim_i - obs_i, and means mu_obs, mu_sim with standard deviations sigma_obs, sigma_sim.</p>
<section id="core-metrics" class="level2">
<h2 class="anchored" data-anchor-id="core-metrics"><strong>Core metrics:</strong></h2>
<ul>
<li><p>Pearson correlation: r = sum((obs_i - mu_obs)(sim_i - mu_sim)) / sqrt(sum((obs_i - mu_obs)^2) * sum((sim_i - mu_sim)^2))</p></li>
<li><p>Linear regression (sim ~ obs): sim_i = a + b * obs_i, where b = cov(obs, sim) / var(obs) and a = mu_sim - b * mu_obs</p></li>
<li><p>MAE: MAE = (1/n) * sum |e_i| - RMSE: RMSE = sqrt((1/n) * sum e_i^2) - Bias: Bias = (1/n) * sum e_i</p></li>
<li><p>Relative bias: RelBias(%) = 100 * Bias / mu_obs (only reported if mu_obs != 0)</p></li>
<li><p>Lin’s concordance correlation coefficient (CCC): CCC = (2 * r * sigma_obs * sigma_sim) / (sigma_obs^2 + sigma_sim^2 + (mu_obs - mu_sim)^2)</p></li>
</ul>
</section>
<section id="event-agreement-binary-events-defined-on-the-reference-series-at-a-threshold" class="level2">
<h2 class="anchored" data-anchor-id="event-agreement-binary-events-defined-on-the-reference-series-at-a-threshold"><strong>Event agreement (binary events defined on the reference series at a threshold):</strong></h2>
<ul>
<li><p>Hits (H): ref event and target event</p></li>
<li><p>Misses (M): ref event and target no-event</p></li>
<li><p>False alarms (F): ref no-event and target event</p></li>
<li><p>Correct negatives (C): ref no-event and target no-event</p></li>
<li><p>POD = H / (H + M)</p></li>
<li><p>FAR = F / (H + F)</p></li>
<li><p>CSI = H / (H + M + F)</p></li>
<li><p>Bias score = (H + F) / (H + M)</p></li>
</ul>
</section>
<section id="seasonal-bias-within-season-s" class="level2">
<h2 class="anchored" data-anchor-id="seasonal-bias-within-season-s"><strong>Seasonal bias within season s:</strong></h2>
<p>Bias_s = mean(sim_i - obs_i) for all paired days in season s</p>
</section>
</section>
<section id="wetwindy-subsets-and-logic" class="level1">
<h1>Wet/windy subsets and logic</h1>
<ul>
<li>Wet days: precipitation metrics are recomputed on days with observed precip above a threshold (default 0.1 to 1 mm) to avoid zero inflation masking disagreement.</li>
<li>many ETCCDI-style indices use RR ≥ 1 mm for wet-day / consecutive wet day style definitions). <strong>1 mm is used as primary “wet day” threshold</strong> (aligns with widely used climate/extremes index conventions e.g.&nbsp;ETCCDI-style definitions) (CITE ETCCDI indicies))++++++++++++++++++++</li>
<li>Windy days: wind metrics are optionally recomputed for high-wind conditions, defined either by a fixed threshold (default 10 m/s) or by the top 10 percent of observed winds in the reference record. When using top-percent thresholds, the cutoff is computed per comparison from the reference overlap period.</li>
</ul>
<p>These subsets surface performance during hydrologically and operationally important conditions.</p>
</section>
<section id="data-availability-overlap" class="level1">
<h1>Data availability / overlap</h1>
<p>Only dates present in both the reference and the compared dataset are used. Time series and distribution plots use the reference dates as the overlap anchor. Coverage tables report first/last date and number of overlapping days for transparency.</p>
<section id="rolling-diagnostics-logic" class="level2">
<h2 class="anchored" data-anchor-id="rolling-diagnostics-logic">Rolling diagnostics logic</h2>
<p>To detect drift through time, moving-window diagnostics (window = 30 days by default) track MAE, RMSE, bias, and correlation. The rolling window is trailing, uses only complete windows, and requires a minimum of paired values for correlation. These plots help identify regime shifts, seasonal dependence, or gradual timing offsets.</p>
</section>
<section id="software-and-packages" class="level2">
<h2 class="anchored" data-anchor-id="software-and-packages">Software and packages</h2>
<p>Analyses were performed in R <span class="citation" data-cites="r:alan2024">(<a href="#ref-r:alan2024" role="doc-biblioref"><em>R: A Language and Environment for Statistical Computing</em> 2024</a>)</span>. Data wrangling and visualization use tidyverse packages (dplyr, tidyr, ggplot2, readr, purrr, tibble, lubridate) <span class="citation" data-cites="tidyverse">(<a href="#ref-tidyverse" role="doc-biblioref">Wickham et al. 2019</a>)</span>. Spatial processing relies on the sf framework <span class="citation" data-cites="sf">(<a href="#ref-sf" role="doc-biblioref">Pebesma 2018</a>)</span>, with leaflet, tmap, osmdata, and rnaturalearth used for mapping. Interactive figures are produced with plotly and tables with reactable and gt. Reproducibility is managed with renv, and report generation uses Quarto with knitr/rmarkdown and htmltools; here is used for stable file paths.</p>
<p>If you want formal citations for every package listed above, regenerate the bibliography with <code>knitr::write_bib()</code> and replace <code>reference.bib</code> with the output.</p>
</section>
</section>
<section id="limitations" class="level1">
<h1>Limitations</h1>
<ul>
<li>Spatial representativeness differs: point sensors (buoy, airport) capture local effects, while gridded/reanalysis products smooth extremes.</li>
<li>Residual timestamp misalignment could affect daily aggregates despite UTC standardisation.</li>
<li>Zero-inflated precipitation can inflate r; wet-day metrics mitigate but do not eliminate this effect.</li>
<li>Findings depend on the overlapping period; results may change with different seasons or longer records.</li>
<li>Wet/windy thresholds are pragmatic; sensitivity checks are recommended if thresholds influence decisions.</li>
</ul>
<p>Future users should adapt thresholds, reference choice, and aggregation rules to their lake, documenting any deviations.</p>
</section>
<section id="references-methods-background" class="level1">
<h1>References (methods background)</h1>
<ol type="1">
<li>Lin, L.I.-K. (1989). A concordance correlation coefficient to evaluate reproducibility.</li>
<li>Jolliffe, I.T., Stephenson, D.B. (eds.). Forecast Verification: A Practitioner’s Guide in Atmospheric Science.</li>
<li>Wilks, D.S. Statistical Methods in the Atmospheric Sciences.</li>
</ol>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-sf" class="csl-entry" role="listitem">
Pebesma, Edzer. 2018. <span>“Simple Features for r: Standardized Support for Spatial Vector Data.”</span> <em>The R Journal</em> 10 (1): 439–46. <a href="https://doi.org/10.32614/RJ-2018-009">https://doi.org/10.32614/RJ-2018-009</a>.
</div>
<div id="ref-r:alan2024" class="csl-entry" role="listitem">
<em>R: A Language and Environment for Statistical Computing</em>. 2024. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-tidyverse" class="csl-entry" role="listitem">
Wickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy McGowan, Romain François, Garrett Grolemund, et al. 2019. <span>“Welcome to the Tidyverse.”</span> <em>Journal of Open Source Software</em> 4 (43): 1686. <a href="https://doi.org/10.21105/joss.01686">https://doi.org/10.21105/joss.01686</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>