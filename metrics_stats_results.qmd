---
title: "Metrics and Statistics"
format: html
params:
  lake_name: "Lake Rotorua"
  lat: -38.114908
  lon: 176.316662
  buffer_km: 10
  lake_id: "rotorua"
  reference: "Airport_1770"
  targets: ["ERA5", "Buoy", "Town_40177", "VCS_On"]
  vars: ["Temp_C", "Precip_mm", "Wind_Spd_ms", "RadSWD_Wm2"]
  wet_threshold_mm: 1
  precip_event_threshold: 1
  windy_top_pct: 0.10
  windy_threshold_ms: 10
  window_days: 30
---

This tab gathers the quantitative diagnostics (coverage, MAE/RMSE/CCC/bias, distributions, scatter, rolling drift). Use it when you want numbers and concise plots for statistical agreement analysis.

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

```{r}
#| echo: false
library(glue)
library(htmltools)
library(gt)
library(plotly)
library(here)
library(tidyverse)
library(lubridate)
library(slider)
library(reactable)

source(here("scripts", "01_metrics_helpers.R"))
source(here("scripts", "03_analysis_helpers.R"))
source(here("scripts", "04_analysis_plotting.R"))
```

```{r}
#| echo: false
# Data setup (same as rotorua.qmd)
file_map <- list(
  ERA5         = here("data/processed/rotorua_era5_daily.csv"),
  Buoy         = here("data/processed/rotorua_buoy_daily.csv"),
  Town_40177   = here("data/processed/rotorua_town_40177_daily.csv"),
  VCS_On       = here("data/processed/rotorua_vcs_on_daily.csv"),
  Airport_1770 = here("data/processed/rotorua_airport_1770_daily.csv")
)

read_from_map <- function(name) {
  readr::read_csv(file_map[[name]], show_col_types = FALSE) |>
    mutate(Date = as.Date(Date))
}

ref_name <- params$reference
target_names <- params$targets

ref_df <- read_from_map(ref_name)
targets_list <- setNames(lapply(target_names, read_from_map), target_names)

wet_threshold_mm <- params$wet_threshold_mm
windy_top_pct <- params$windy_top_pct
windy_threshold_ms <- params$windy_threshold_ms
window_days <- params$window_days

vars_requested <- params$vars
vars_available <- Reduce(
  intersect,
  c(list(names(ref_df)), lapply(targets_list, names))
)
vars <- intersect(vars_requested, vars_available)
```

## Coverage summary

```{r}
#| label: tbl-Coverage
#| tbl-cap-location: top
#| tbl-cap: "Data sets obtained and used, showing date range and count per dataset, later fitted and compared to the reference (airport) coverage 2009-2025"
coverage <- bind_rows(
  Reference = ref_df,
  !!!targets_list,
  .id = "Dataset"
) |>
  group_by(Dataset) |>
  summarise(
    first_date = min(Date, na.rm = TRUE),
    last_date  = max(Date, na.rm = TRUE),
    n_days     = sum(!is.na(Date)),
    .groups = "drop"
  )

reactable(
  coverage,
  sortable = TRUE,
  striped = TRUE,
  pagination = FALSE
)
```

## Metrics table (MAE, RMSE, CCC, bias)

Includes all days plus wet-day and windy-day subsets where relevant. Sort/filter to focus on a variable (var) or subset.

```{r}
#| label: tbl-Metrics
#| tbl-cap-location: top
#| tbl-cap: "Metrics table showing outputs mean absolute error (MAR), correlation (cor), slope, intercept, root mean squared error (RMSE), concordance correlation coeficient (CCC) and wind threshold for all target sources (ERA5, Buoy, Town, VCSN) and their subsets (all_days, wet_days_observed >1mm, windy_top_10%_observed) across temperature (C), Wind (m s⁻¹) and precipitation (mm) variables (var) where n=number of dataset points (days) and the reference is the airport observational data."
metrics_all <- purrr::imap_dfr(
  targets_list,
  ~ metrics_vs_ref(
    ref_df      = ref_df,
    target_df   = .x,
    target_name = .y,
    vars = vars,
    wet_threshold_mm = wet_threshold_mm,
    windy_threshold_ms = windy_threshold_ms,
    windy_top_pct = windy_top_pct
  )
)

reactable(
  metrics_all,
  searchable = TRUE,
  sortable = TRUE,
  highlight = TRUE,
  defaultPageSize = 12,
  columns = list(
    cor = colDef(format = colFormat(digits = 2)),
    slope = colDef(format = colFormat(digits = 2)),
    intercept = colDef(format = colFormat(digits = 2)),
    mae = colDef(format = colFormat(digits = 2)),
    rmse = colDef(format = colFormat(digits = 2)),
    ccc = colDef(format = colFormat(digits = 2)),
    bias = colDef(format = colFormat(digits = 2)),
    rel_bias = colDef(format = colFormat(digits = 1))
  )
)
```

### Temperature (Temp_C)

Town_40177 shows near‑perfect agreement with Airport_1770 (r=0.99, RMSE=0.48, bias=0.01). ERA5 is strong but cool‑biased (r=0.95, RMSE=1.42, bias −0.53). Buoy and VCS_On are similar in correlation (r=0.92 and 0.91) with slight warm biases (bias +0.87 and +0.48, RMSE \~1.8). Overall high agreeability across all datasets with = or \> 0.90 CCC score

### Precipitation (Precip_mm)

VCS_On and Town_40177 show the best overall agreement for all days (r=0.95 and 0.93; RMSE 3.68 and 4.08; CCC=0.94 and 0.92), with small biases. ERA5 shows lower performance but overestimates rain (r=0.74, RMSE=8.87, bias +2.62; CCC=0.71). Buoy performs weakest (r=0.61, RMSE=10.03, bias −2.99) with low agreement (CCC=0.49). On wet days (\>1 mm), performance drops for all datasets; VCS_On remains highest (r=0.93, RMSE=6.48), Town_40177 is close (r=0.91, RMSE=6.83), while ERA5 lowers in agreement (CCC=0.65) and Buoy show the lowest agreement (CCC=0.40).

### Wind speed (Wind_Spd_ms)

On all days, VSC_On shows the highest agreement (CCC=0.82) with the lowest MAE (0.7) and RMSE (0.93). Town_40177 has the highest correlation (r=0.88) with a CCC of 0.70, but a negative bias (−0.81); VCS_On has the lowest RMSE (0.93) and near‑zero bias (+0.14). Buoy is moderate (r=0.78, RMSE=1.29, bias +0.65) with the second highest CCC (0.72). ERA5 is weakest (r=0.61, RMSE=1.95, bias −1.49) with the lowest CCC (0.03). In the top 10% windy subset, all datasets reduce sharply; Town_40177 retains the highest r (0.73) but still underestimates extremes. VCS_On has the lowest RMSE (1.50), Buoy is weakly correlated, and ERA5 performs poorest (r=0.20, RMSE=3.71, bias −3.46).

## Distribution and bias shape

Density distribution overlays show bias or spread differences

```{r}
#| label: fig-Density-Temp
#| fig-cap: "Density distribution overlays of daily temperature (°C) for each dataset on the overlapping period with the reference dataset. Shifts in the curves indicate systematic warm/cool bias; differences in tail thickness indicate changes in variability or extremes."
plot_distribution(ref_df, targets_list, "Temp_C")
```

The distributions are broadly similar, but ERA5 is shifted slightly cooler (left of the reference), while Buoy and VCS_On are shifted warmer (right of the reference). Town_40177 most closely overlaps the reference distribution. Differences in tail thickness suggest small changes in variability, but the overall temperature range is consistent.

```{r}
#| label: fig-density-wind
#| fig-cap: "Density distribution overlays of daily wind speed (m s⁻¹) for each dataset on the overlapping period with the reference. The reference distribution is shown for comparison."
plot_distribution(ref_df, targets_list, "Wind_Spd_ms")
```

ERA5 is shifted to lower wind speeds (left) with a longer tail, showing a consistent low‑wind bias. Buoy and VCS_On have higher density right tails (higher wind) than the reference, showing higher frequency of moderate–strong winds measurments. Town_40177 is closest to the reference peak but has dampend higher wind records.

```{r}
#| label: fig-Histogram-Precip
#| fig-cap: "Histogram of daily precipitation (mm) for all datasets, including dry days (zero‑inflated). This highlights differences in event frequency and the heavy‑tail behaviour of rainfall extremes."
plot_distribution(ref_df, targets_list, "Precip_mm")
```

All datasets are strongly zero‑inflated, but ERA5 shows a longer right tail and more moderate rainfall counts that are spread out, consistent with wet bias. Buoy has fewer non‑zero counts, indicating a lack of precipitation detection. VCS_On is closest to the reference, with similar tails and event frequencies. Town_40177 follows a similar pattern to the reference, but seems to underrepresent rain.

## Scatter vs reference (1:1)

Scatter plots to check linear agreement and systematic bias

```{r}
#| label: fig-Scatter-temp
#| fig-cap: "Scatter plots of daily temperature (°C) for each dataset against the Airport_1770 reference. The dashed line indicates 1:1 agreement and the solid line is the fitted regression. All datasets show strong linear relationships; Town_40177 has the tightest agreement and minimal bias, ERA5 shows a small cool bias, and Buoy/VCS_On show modest warm biases. Each panel reports n, R, RMSE, and bias."
plot_scatter_faceted(ref_df, targets_list, "Temp_C", ncol = 2)
  #points should cluster along the 1:1 line.
```

Temperature agreement is strong across all datasets, with near‑linear relationships. Town_40177 has near‑perfect agreement (r≈0.99, very low RMSE and near‑zero bias). ERA5 shows high correlation and low RMSE with a small cool bias. Buoy and VCS_On remain strongly correlated but show warm biases relative to the airport.

```{r}
#| label: fig-scatter-wind
#| fig-cap: "Scatter plots of daily wind speed (m s⁻¹) for each dataset against the Airport_1770 reference. The dashed line indicates 1:1 agreement and the solid line is the fitted regression. Town_40177 and VCS_On show the highest correlations and lowest errors, while Buoy exhibits a modest positive bias and ERA5 shows a pronounced negative bias with the largest RMSE. Sample size (n), correlation (R), RMSE, and bias are reported in each panel"
plot_scatter_faceted(ref_df, targets_list, "Wind_Spd_ms", ncol = 2)
```

All datasets show positive associations with the airport reference, but performance differs. Town_40177 and VCS_On show the strongest correlations and lowest errors, with regression lines closest to the 1:1 line. Buoy shows lower but moderate correlation and a positive bias (overestimation), while ERA5 shows weaker correlation and a strong negative bias (underestimation) with the largest RMSE among the four.

```{r}
#| label: fig-scatter-precip
#| fig-cap: "Fig Scatter plots of daily precipitation (mm) for each dataset source (Town_40177, ERA5, VSCN and Buoy data) against the Airport_1770 reference. The dashed line is 1:1 agreement; the solid line is the fitted regression. VCS_On and Town_40177 show the highest correlations and lowest RMSE, ERA5 shows moderate agreement with a positive bias, and Buoy shows the weakest agreement and the largest error. Panel annotations report n, R, RMSE, and bias."
plot_scatter_faceted(ref_df, targets_list, "Precip_mm", ncol = 2)
```

Rainfall agreement is highly variable across datasets. VCS_On and Town_40177 show the strongest linear agreement (high r, low RMSE), with regression lines close to 1:1. ERA5 shows moderate but a positive bias (overestimation). Buoy has the weakest agreement, largest RMSE, and a negative bias, reflecting poorer partnership with the airport precipitation.

```{r}
#| label: fig-scatter-rad
#| fig-cap: "Fig. Scatter plots of daily Radiation Wm2 for each dataset source (Town_40177, ERA5, VSCN and Buoy data) against the Airport_1770 reference. The dashed line is 1:1 agreement; the solid line is the fitted regression.Panel annotations report n, R, RMSE, and bias."
if ("RadSWD_Wm2" %in% vars) plot_scatter_faceted(ref_df, targets_list, "RadSWD_Wm2", ncol = 2)
```

## Rolling diagnostics (drift through time)

Rolling diagnostics reveal gradual offsets or drift through time where breaks away from 0 bias or a changing correlation is looked for, answering the "does it shift seasonally?" question.

### Temperature

```{r}
#| label: fig-rolling-temp
#| fig-cap: "Rolling 30‑day diagnostics for daily temperature (°C) comparing data target sources (Town_40177, ERA5, VSCN and Buoy data) to the reference (Airport_1770). Panels show 30‑day moving bias (source/target − reference), Pearson correlation (cor), mean absolute error (MAE), and Root mean square error (RMSE)."
#| fig-subcap:
#|   - "ERA5 vs Airport reference"
#|   - "Buoy vs Airport reference"
#|   - "Town vs Airport reference"
#|   - "VSCN vs Airport reference"
#| layout-ncol: 2
purrr::iwalk(targets_list, ~ print(plot_rolling_diagnostics(ref_df, .x, .y, "Temp_C", window_days = window_days)))
#These track moving-window bias/CCC to surface gradual timing offsets or seasonal drifts.
```

### ERA5 temperature

The bias is consistently negative, indicating ERA5 is cooler than the airport on average. Correlation remains moderate to high with intermittent dips, while MAE/RMSE show modest oscillations without extreme spikes, suggesting stable but slightly biased performance. ERA5 temperatures are lower than Airport_1770 across the plot. Correlation is generally strong with short, sharp, low values, indicating good temporal tracking most of the time. Moderate error levels: MAE/RMSE remain relatively steady with small oscillations.

### Buoy temperature

Bias is mostly positive, with two standout negative points. In particular, in late 2019, which coincides with sharp drops in correlation and spikes in MAE/RMSE due to data errors/missreadings in this period. Outside these events, correlation is high, and errors are low. Buoy temperatures tend to be higher than the reference.

### Town temperature

Bias is near zero for much of the record, showing agreement, but in 2025 a defined negative bias, drop in correlation and sharp increases in MAE/RMSE show more measurement errors.

### VCSN temperature

Bias is consistently positive, indicating VCS_On is warmer on average. Correlation is moderate and variable with frequent dips, while MAE/RMSE shows more consistent oscillations without extreme spikes.

### Wind

```{r}
#| label: fig-rolling-wind
#| fig-cap: "Rolling 30‑day diagnostics for daily wind speed (m s⁻¹) comparing data target sources (Town_40177, ERA5, VSCN and Buoy data) to the reference (Airport_1770). Panels show 30‑day moving bias (source/target − reference), Pearson correlation (cor), mean absolute error (MAE), and Root mean square error (RMSE)."
#| fig-subcap:
#|   - "ERA5 vs Airport reference"
#|   - "Buoy vs Airport reference"
#|   - "Town vs Airport reference"
#|   - "VCSN vs Airport reference"
#| layout-ncol: 2
purrr::iwalk(targets_list, ~ print(plot_rolling_diagnostics(ref_df, .x, .y, "Wind_Spd_ms", window_days = window_days)))
```

## Town wind

Bias is mostly negative, showing overall low bias in Town_40177 relative to Airport_1770. Correlation is high for most of the record but shows intermittent drops, along with short periods of increased MAE/RMSE. Error magnitudes are somewhat low, but show periods of spikes, indicating periods of reduced agreement that are short lived rather than more permanant. Correlation is typically high (near the upper range of the axis). Some short, sharp drops in correlation and peaks in MAE and RMSE in mid 2018.

## ERA5 wind

For the ERA5 source the bias is consistently negative across the timeline, showing underestimation of wind speed by ERA5. Correlation fluctuates around moderate values with frequent short‑lived drops, while MAE and RMSE show pronounced seasonal oscillations with episodes of peaks. Persistent low bias: ERA5 wind speeds are consistently below the airport reference (negative bias throughout). Lower day to day agreement and more volatile than some other station to station comparison, with frequent dips in correlation. MAE/RMSE show clear oscillations and repeated peaks. Several short sharp drops in correlation and elevated errors.

## VCSN wind

Bias shifts over time from slightly positive in the early record toward near‑zero and then slightly negative values, indicating a gradual drift in mean offset. Correlation remains moderate to high with intermittent dips, while MAE/RMSE display recurring oscillations without large spikes.

Slow bias drift are seen. Mean bias trends from positive to slightly negative across the record, showing gradual change in relative wind magnitude. Correlation is generally moderate–high with periodic drops, reflecting time‑varying agreement. MAE/RMSE show cyclical variability but no extreme excursions, suggesting steady performance without major anomalies. VCS_On captures wind variability reasonably well, but bias may need adjustment.

## Buoy wind

A pronounced early  anomaly is evident as a sharp negative bias, collapse in correlation, and a simultaneous spike in MAE/RMSE. Outside this episode, bias remains small and positive, correlation is generally high, and errors are comparatively low with occasional minor excursions.

Early anomaly dominates with a short early interval shows extreme disagreement (large negative bias, correlation collapse, large MAE/RMSE), indicating a likely data issue or calibration mismatch in that period. Otherwise strong agreement. After the anomaly, correlation stays high and error levels are low, implying good temporal coherence between buoy and airport winds. The buoy shows a slight positive bias relative to the airport in the stable period. Later deviations are modest and short‑lived, suggesting the relationship is stable after initial issues.

### Precipitation

```{r}
#| label: fig-rolling-precip
#| fig-cap: "Rolling 30‑day diagnostics for daily total precipitation (mm) comparing data target sources (Town_40177, ERA5, VSCN and Buoy data) to the reference (Airport_1770). Panels show 30‑day moving bias (source/target − reference), Pearson correlation (cor), mean absolute error (MAE), and Root mean square error (RMSE)."
#| fig-subcap:
#|   - "ERA5 vs Airport reference"
#|   - "Buoy vs Airport reference"
#|   - "Town vs Airport reference"
#|   - "VCS vs Airport reference"
#| layout-ncol: 2
purrr::iwalk(targets_list, ~ print(plot_rolling_diagnostics(ref_df, .x, .y, "Precip_mm", window_days = window_days)))
```