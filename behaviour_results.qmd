---
title: "Seasonal and Event Behaviour"
format: html
params:
  lake_name: "Lake Rotorua"
  lat: -38.114908
  lon: 176.316662
  buffer_km: 10
  lake_id: "rotorua"
  reference: "Airport_1770"
  targets: ["ERA5", "Buoy", "Town_40177", "VCS_On"]
  vars: ["Temp_C", "Precip_mm", "Wind_Spd_ms", "RadSWD_Wm2"]
  wet_threshold_mm: 1
  precip_event_threshold: 1
  windy_top_pct: 0.10
  windy_threshold_ms: 10
  window_days: 30
---

This page focuses on behaviour: when datasets agree on events, where they miss each other (zeros vs non-zeros, timing offsets, extremes), and how datasets change over different seasons.

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

```{r}
#| echo: false
library(glue)
library(htmltools)
library(gt)
library(plotly)
library(here)
library(tidyverse)
library(lubridate)
library(slider)
library(reactable)

# Source shared helpers
source(here("scripts", "01_metrics_helpers.R"))
source(here("scripts", "03_analysis_helpers.R"))
source(here("scripts", "04_analysis_plotting.R"))
```

```{r}
#| echo: false
# Data setup (mirrors rotorua.qmd)
file_map <- list(
  ERA5         = here("data/processed/rotorua_era5_daily.csv"),
  Buoy         = here("data/processed/rotorua_buoy_daily.csv"),
  Town_40177   = here("data/processed/rotorua_town_40177_daily.csv"),
  VCS_On       = here("data/processed/rotorua_vcs_on_daily.csv"),
  Airport_1770 = here("data/processed/rotorua_airport_1770_daily.csv")
)

read_from_map <- function(name) {
  readr::read_csv(file_map[[name]], show_col_types = FALSE) |>
    mutate(Date = as.Date(Date))
}

ref_name <- params$reference
target_names <- params$targets

ref_df <- read_from_map(ref_name)
targets_list <- setNames(lapply(target_names, read_from_map), target_names)

wet_threshold_mm <- params$wet_threshold_mm
precip_event_threshold <- params$precip_event_threshold
windy_top_pct <- params$windy_top_pct
windy_threshold_ms <- params$windy_threshold_ms
window_days <- params$window_days

# only keep variables present in all datasets to prevent render errors
vars_requested <- params$vars
vars_available <- Reduce(
  intersect,
  c(list(names(ref_df)), lapply(targets_list, names))
)
vars <- intersect(vars_requested, vars_available)
```

## Precipitation event structure: The following plots show how precipitation volumes and timing align across datasets.


::: panel-tabset
### 7-day total
```{r}
#| label: fig-Rolling-7-hydro
#| fig-cap: "7-day rolling hydrograph showing total precipitation (mm/7day) for all datasets (Airport, Buoy, Town, ERA5, VCS) at Lake Rotorua."
plot_precip_hydrograph(ref_df, targets_list, display = "rolling", window_days = 7)
```

### Daily Hydrograph
```{r}
#| label: fig-hydrograph
#| fig-cap: "Hydrograph of daily precipitation (mm) for all datasets (Airport, Buoy, Town, ERA5, VCS) for Lake Rotorua."
plot_precip_hydrograph(ref_df, targets_list, display = "bars")
```
:::

```{r}
#| label: fig-cumulative-freq
#| fig-cap: "Cumulative distribution functions (CDFs) of daily precipitation for each dataset (Airport, Buoy, Town, ERA5, VCS) for Lake Rotorua. Curves further to the right indicate heavier tails (more high‑rain days), while curves higher at low precipitation indicate more light‑rain or dry days."
plot_precip_cdf(ref_df, targets_list)
```


ERA5’s curve is shifted rightward, indicating more frequent moderate to high rainfall (wet bias). The buoy curve rises faster at low precipitation, indicating fewer heavy‑rain days and a tendency toward under tracking. Town_40177 and VCS_On track the reference most closely across the distribution, showing potential better fit in both light and heavy rain.

```{r}
#| label: fig-histogram-ncol2-rain
#| fig-cap: "Histograms of daily precipitation on wet days only (reference > 1 mm), shown separately for each dataset (Airport, Buoy, Town, ERA5, VCS) for Lake Rotorua. This removes zero‑inflation and highlights agreement in the distribution of event magnitudes"
plot_precip_wetday_distribution(ref_df, targets_list, threshold_mm = wet_threshold_mm)
```


ERA5 shows the broadest distribution and the longest upper tail, which aligns with overestimation of heavier events. Town_40177 and VCS_On align more closely with the reference shape, indicating better magnitude agreement on wet days. The buoy distribution is pressed toward lower totals, indicating underestimation of event magnitudes.

## Event detection and mismatches

Use these to spot zero vs non zero disagreements, misses/false alarms, and timing offsets during wet events. POD: Probability detection FAR: False alarm ratio CSI: Critical success inder Bias score:

```{r}
#| echo: false
skill_precip <- event_skill_all_targets(
  ref_df, targets_list,
  var = "Precip_mm",
  threshold = precip_event_threshold,
  direction = ">="
)

reactable(
  skill_precip,
  sortable = TRUE,
  striped = TRUE,
  pagination = FALSE,
  highlight = TRUE,
  defaultPageSize = 10
)
```

```{r}
#| label: fig-precip-events
#| fig-cap: "Stacked counts of precipitation event outcomes (threshold ≥ 1 ) for each dataset (ERA5, Buoy, Town, VCS) relative to the reference (Airport)."
plot_event_outcomes(
  skill_precip,
  title = paste0("Precip events (\u2265 ", precip_event_threshold, " mm/day): outcomes vs reference")
)
```


ERA5 produces many hits but also the largest false‑alarm count, while Town_40177 shows the most balanced outcomes (high hits, low false alarms). VCS_On is conservative (few false alarms but more misses), and Buoy has fewer hits overall.

```{r}
#| label: fig-Rain-event-scores
#| fig-cap: "Event‑detection skill for precipitation ≥ 1 mm per day, showing Probability detection (POD), false alarm ration (FAR), critical success index (CSI) and bias."
plot_event_skill_scores(
  skill_precip,
  title = paste0("Precip events (\u2265 ", precip_event_threshold, " mm/day): skill vs reference")
)
```


Town_40177 has the highest critical sucess index (CSI) score and low ralse alarm ratio (FAR), indicating the most robust event agreement. ERA5 shows the highest probability of detection (POD), but also the highest FAR and bias_score (>1), showing its over prediction nature. VCS_On shows low FAR and lower POD, while the Buoy data has the weakest skill overall, but also the lowest overall counts compared to the reference.

```{r}
#| label: fig-false-alarm-mag
#| fig-cap: "Distribution of false‑alarm precipitation amounts (ref ≤ 1 mm per day, target > 1 mm per day) on a log1p scale."
plot_false_alarm_magnitude(ref_df, targets_list, threshold_mm = precip_event_threshold)
```


ERA5 shows the largest and most frequent false alarm magnitudes, while Town_40177 and VCS_On are more constrained. Buoy contributes few false alarms but also fewer detected events overall.


ERA5 VCS and Town all have a bias score 1 or >1 and 0.9 or greater POD, indicating over prediction of rain (more false alarms), while the Buoy data has lower bias score (0.52) and POD (0.44) showing it underpredicts rain events. Even thought ERA5 had the highest POD it also had the highest FAR (0.42) while VCS has the lowest FAR and strongest CSI (0.827). Town also produced a strong CSI (0.824) while ERA5 and Buoy both have weak to moderate scores.



## Seasonal behaviour

Climatology and seasonal bias plots show potential detection or lack of for extremes across the year.

```{r}
#| label: fig-climatology-temp
#| fig-cap: "Monthly climatology of daily temperature (°C) for each dataset (Airport, ERA5, Buoy, Town, VCS), showing monthly means (lines) and interquartile ranges (shaded bands 25 and 75). Airport_1770 is the reference; other datasets are overlaid to highlight seasonal offsets and variability. Showing any systematic seasonal bias in mean and variability. Uses overlap with reference dates to ensure fair comparison."
plot_monthly_climatology(ref_df, targets_list, "Temp_C")
```
 


All datasets reproduce the same seasonal cycle (summer peak, winter minimum). ERA5 is consistently cooler than the reference, while Buoy and VCS_On are warmer. Town_40177 tracks the airport most closely across all months. IQR bands broadly overlap, indicating similar seasonal variability, but the persistent offsets indicate systematic seasonal bias rather than random error.

```{r}
#| label: fig-climatology-wind
#| fig-cap: "Monthly climatology of daily wind speed (m s⁻¹) from datasets (Airport, Buoy, ERA5, Town, VCS), with monthly means and IQR shading. Differences in mean level and spread reveal seasonal wind biases relative to the reference."
plot_monthly_climatology(ref_df, targets_list, "Wind_Spd_ms")
```


All datasets show higher winds in spring and summer and lower in winter, but the magnitude differs. ERA5 is consistently lower than the reference across all months (systematic low bias). Buoy and VCS_On are higher than the reference, while Town_40177 is lower. The VCS_On bands are closest to the reference, The thisckness in the IQR bands suggest greater variation or local effects.

```{r}
#| label: fig-climatology-precip
#| fig-cap: "Monthly climatology of daily precipitation (mm) for each dataset (Airport, Buoy, ERA5, Town, VCS), showing monthly means and IQRs. This highlights seasonal rainfall patterns and dataset‑specific wet biases."
plot_monthly_climatology(ref_df, targets_list, "Precip_mm")
```


All datasets show a winter spring increase and a relative summer decrease, but the magnitude differs substantially. ERA5 is consistently wetter than the reference across months, while Buoy is clearly drier exept for september. Town_40177 aligns closely with the airport, and VCS_On is slightly wetter in several months but closer in the warmer dryer parts of the year. Wider IQRs for ERA5 indicate more variability and heavier tails.

```{r}
#| label: fig-seasonal-bias-temp_C
#| fig-cap: "Seasonal mean temperature bias of ((target (Buoy, ERA5, Town, VCS) − reference(airport)) with interquartile ranges. Positive values indicate warm bias; negative values indicate cool bias."
season_defs <- season_defs_default
plot_seasonal_bias(ref_df, targets_list, "Temp_C", season_defs = season_defs)
```


ERA5 is cool biased in all seasons, most pronounced spring. Buoy shows a warm bias in all seasons, especially autumn/winter. Town_40177 is near zero in every season (best match). VCS_On is consistently warm biased but smaller than Buoy.


```{r}
#| label: fig-scatter-season-wind_ms
#| fig-cap: "Seasonal scatter plots of daily wind comparing each dataset (ERA5, Buoy, Town, VCS) to the reference (Airport) dataset. Dashed lines indicate 1:1 agreement; solid lines are fitted regressions. Rows represent seasons; columns represent datasets."
plot_seasonal_scatter(ref_df, targets_list, "Wind_Spd_ms", season_defs = season_defs)
```


Town_40177 and VCS_On show tighter clustering around the 1:1 line across seasons, indicating stronger agreement. ERA5 shows systematic underestimation (regression slope < 1) in all seasons, especially at higher winds. Buoy shows reasonable agreement but with more spread in summer and spring.

```{r}
#| label: fig-seasonal-scatter-precip_mmday
#| fig-cap: "Seasonal scatter plots of daily rain comparing each dataset (ERA5, Buoy, Town, VCS) to the reference (Airport) dataset. Dashed lines indicate 1:1 agreement; solid lines are fitted regressions. Rows represent seasons; columns represent datasets."
plot_seasonal_scatter(ref_df, targets_list, "Precip_mm", season_defs = season_defs)
```


VCS_On are closest to the 1:1 line in all seasons, indicating the best precipitation agreement. Town and ERA5 tends to overestimate moderate and heavy events (slope > 1), while Buoy underestimates rainfall across seasons and shows the greatest dispersion at higher totals.