---
title: "Rotorua demo"
author: "Cady B"
editor: visual
bibliography: reference.bib
params:
  lake_name: "Lake Rotorua"
  lat: -38.114908
  lon: 176.316662
  buffer_km: 10
---

## Site data sources

note add what kindof lat long system used\_\_\_\_\_

Limnotrack Buoy (lat:-380550S Lon:1761653E) on lake, NIWA virtual climate station network (VCSN) grid NO:27879 lat:-38.075 lon:176.275, ERA5 statlite data for Lat:-38.114908 and Lon:176.316662, Observational data "Airport" station 1770 (lat:-38.10592 lon:176.31481), Obresvational data "Town" station 41077 (lat:-38.14635 lon:176.2578).



```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,        # show code on website (you can set FALSE later)
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)

library(glue)
library(htmltools)
library(gt)
library(plotly)
library(here)
library(tidyverse)
library(lubridate)
library(slider)
library(here)
library(reactable)

# ---- Source scripts (from project root) ----
source(here("scripts", "01_metrics_helpers.R"))
source(here("scripts", "03_analysis_helpers.R"))
source(here("scripts", "04_analysis_plotting.R"))

# ---- Params safety (so render works even if someone runs the file directly) ----
default_params <- list(
  lake_name = "Lake Rotorua",
  lake_id = "rotorua",
  reference = "Airport_1770",
  targets = c("ERA5", "Buoy", "Town_40177", "VCS_On"),
  vars = c("Temp_C", "Precip_mm", "Wind_Spd_ms", "RadSWD_Wm2"),
  wet_threshold_mm = 1,
  windy_top_pct = 0.10,
  windy_threshold_ms = 10,
  window_days = 30
)

if (!exists("params")) params <- list()
params <- modifyList(default_params, params)

# ---- File map (Rotorua demo uses rotorua_*.csv; other lakes can swap lake_id later) ----
file_map <- list(
  ERA5         = here("data/processed/rotorua_era5_daily.csv"),
  Buoy         = here("data/processed/rotorua_buoy_daily.csv"),
  Town_40177   = here("data/processed/rotorua_town_40177_daily.csv"),
  VCS_On       = here("data/processed/rotorua_vcs_on_daily.csv"),
  Airport_1770 = here("data/processed/rotorua_airport_1770_daily.csv")
)

read_from_map <- function(name) {
  readr::read_csv(file_map[[name]], show_col_types = FALSE) |>
    mutate(Date = as.Date(Date))
}

# ---- Data ----
ref_df <- read_from_map(params$reference)
targets_list <- setNames(lapply(params$targets, read_from_map), params$targets)
vars <- params$vars

# ---- Colours (must match source names in plots) ----
target_colors <- c(
  Airport_1770 = "black",
  ERA5         = "#d95f02",
  Buoy         = "#7570b3",
  Town_40177   = "#f0c400",
  VCS_On       = "#1b9e77"
)

```


## Data coverage

```{r}
coverage <- bind_rows(
  Reference = ref_df,
  !!!targets_list,
  .id = "Dataset"
) |>
  group_by(Dataset) |>
  summarise(
    first_date = min(Date, na.rm = TRUE),
    last_date  = max(Date, na.rm = TRUE),
    n_days     = n(),
    .groups = "drop"
  )

reactable(
  coverage,
  sortable = TRUE,
  striped = TRUE,
  pagination = FALSE
)
```

## Metrics table (reference vs targets)

```{r}
metrics_all <- purrr::imap_dfr(
  targets_list,
  ~ metrics_vs_ref(
    ref_df = ref_df,
    target_df = .x,
    target_name = .y,
    vars = vars,
    wet_threshold_mm = 1,
    windy_top_pct = 0.10
  )
)

reactable(
  metrics_all,
  searchable = TRUE,
  sortable = TRUE,
  highlight = TRUE,
  defaultPageSize = 8,
  pagination = TRUE,
  columns = list(
    cor = colDef(format = colFormat(digits = 2)),
    slope = colDef(format = colFormat(digits = 2)),
    intercept = colDef(format = colFormat(digits = 2)),
    mae = colDef(format = colFormat(digits = 2)),
    rmse = colDef(format = colFormat(digits = 2)),
    ccc = colDef(format = colFormat(digits = 2)),
    bias = colDef(format = colFormat(digits = 2)),
    rel_bias = colDef(format = colFormat(digits = 1))
  )
)
```

## Time series overlays

```{r}
ts_long <- bind_rows(
  Reference = ref_df,
  !!!targets_list,
  .id = "Dataset"
) |>
  pivot_longer(
    cols = all_of(vars),
    names_to = "Variable",
    values_to = "Value"
  ) |>
  drop_na(Value)

make_ts_plot <- function(var) {
  df <- ts_long |> filter(Variable == var)
  x_rng <- range(df$Date, na.rm = TRUE)
  y_rng <- range(df$Value, na.rm = TRUE)
  p <- ggplot(df, aes(Date, Value, color = Dataset)) +
    geom_line() +
    facet_wrap(~Dataset, ncol = 1, scales = "fixed") +
    coord_cartesian(xlim = x_rng, ylim = y_rng) +
    labs(title = var, x = NULL, y = var) +
    scale_color_manual(
      values = c(
        "Buoy" = "#1f77b4",       # blue
        "ERA5" = "#d95f02",       # dark orange
        "Reference" = "#000000",  # black
        "Town_40177" = "#7570b3", # purple
        "VCS_On" = "#1b9e77"      # green
      )
    ) +
    theme_minimal() +
    theme(legend.position = "none")
  ggplotly(p, tooltip = c("Date", "Value", "Dataset"))
}

lapply(vars, make_ts_plot)
```





## Defaults (static view)

```{r}
selected_target_name <- params$targets[[1]]
selected_var <- vars[[1]]

plot_data <- bind_rows(
  Reference = ref_df |> select(Date, all_of(selected_var)),
  Target    = targets_list[[selected_target_name]] |> select(Date, all_of(selected_var)),
  .id = "Series"
)
```

## Latest snapshot cards

```{r}
latest_ref <- ref_df |> filter(!is.na(Date)) |> slice_max(Date, n = 1, with_ties = FALSE)

card_badge <- function(label, value, suffix = "", status = c("secondary", "success", "warning", "danger")) {
  status <- match.arg(status)
  htmltools::div(
    class = "card text-bg-dark mb-3",
    style = "min-width: 14rem;",
    htmltools::div(
      class = "card-header d-flex justify-content-between align-items-center",
      label,
      htmltools::span(class = glue("badge text-bg-{status}"), glue("{round(value, 2)}{suffix}"))
    )
  )
}

precip_status <- if (latest_ref$Precip_mm >= params$wet_threshold_mm) "primary" else "secondary"
wind_status <- if (latest_ref$Wind_Spd_ms >= params$windy_threshold_ms) "warning" else "secondary"

div(
  class = "d-flex flex-wrap gap-3",
  card_badge("Temp (C)", latest_ref$Temp_C, status = "secondary"),
  card_badge("Precip (mm)", latest_ref$Precip_mm, status = precip_status),
  card_badge("Wind (m/s)", latest_ref$Wind_Spd_ms, status = wind_status),
  card_badge("SW Rad (W/m2)", latest_ref$RadSWD_Wm2, status = "secondary")
)
```



## Interactive table

```{r}
latest_table <- map_dfr(
  setNames(c(params$reference, params$targets), c("Reference", params$targets)),
  function(name) {
    df <- read_from_map(name) |> filter(!is.na(Date))
    last_row <- slice_max(df, Date, n = 1, with_ties = FALSE)
    tibble(
      Dataset    = name,
      Date       = last_row$Date,
      Temp_C     = last_row$Temp_C,
      Precip_mm  = last_row$Precip_mm,
      Wind_Spd_ms= last_row$Wind_Spd_ms,
      RadSWD_Wm2 = last_row$RadSWD_Wm2
    )
  }
)

reactable(
  latest_table,
  searchable = TRUE,
  sortable = TRUE,
  pagination = TRUE,
  striped = TRUE,
  highlight = TRUE,
  defaultPageSize = 5
)
```
