---
title: "Rotorua demo"
author: "Cady B"
editor: visual
bibliography: reference.bib
params:
  lake_name: "Lake Rotorua"
  lat: -38.114908
  lon: 176.316662
  buffer_km: 10
  lake_id: "rotorua"
  reference: "Airport_1770"
  targets: ["ERA5", "Buoy", "Town_40177", "VCS_On"]
  vars: ["Temp_C", "Precip_mm", "Wind_Spd_ms", "RadSWD_Wm2"]
  wet_threshold_mm: 1
  precip_event_threshold: 0.1
  windy_top_pct: 0.10
  windy_threshold_ms: 10
  window_days: 30
---

## Site data sources

note add what kindof lat long system used\_\_\_\_\_

Limnotrack Buoy (lat:-380550S Lon:1761653E) on lake, NIWA virtual climate station network (VCSN) grid NO:27879 lat:-38.075 lon:176.275, ERA5 statlite data for Lat:-38.114908 and Lon:176.316662, Observational data "Airport" station 1770 (lat:-38.10592 lon:176.31481), Obresvational data "Town" station 41077 (lat:-38.14635 lon:176.2578).

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,        # show code on website (you can set FALSE later)
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

```{r}
# | echo: true
library(glue)
library(htmltools)
library(gt)
library(plotly)
library(here)
library(tidyverse)
library(lubridate)
library(slider)
library(here)
library(reactable)

# ---- Source scripts (from project root) ----
source(here("scripts", "01_metrics_helpers.R"))
source(here("scripts", "03_analysis_helpers.R"))
source(here("scripts", "04_analysis_plotting.R"))
```

```{r}
#| echo: False
# --- Load processed daily data for Rotorua (project-standard) ---
file_map <- list(
  ERA5         = here("data/processed/rotorua_era5_daily.csv"),
  Buoy         = here("data/processed/rotorua_buoy_daily.csv"),
  Town_40177   = here("data/processed/rotorua_town_40177_daily.csv"),
  VCS_On       = here("data/processed/rotorua_vcs_on_daily.csv"),
  Airport_1770 = here("data/processed/rotorua_airport_1770_daily.csv")
)

read_from_map <- function(name) {
  readr::read_csv(file_map[[name]], show_col_types = FALSE) |>
    mutate(Date = as.Date(Date))
}

ref_name <- params$reference
target_names <- params$targets

ref_df <- read_from_map(ref_name)
targets_list <- setNames(lapply(target_names, read_from_map), target_names)

# --- Colors used by plot functions ---
target_colors <- c(
  Airport_1770 = "black",
  ERA5         = "#d95f02",
  Buoy         = "#7570b3",
  Town_40177   = "#f0c400",
  VCS_On       = "#1b9e77"
)

# --- Thresholds ---
wet_threshold_mm <- params$wet_threshold_mm
precip_event_threshold <- params$precip_event_threshold
windy_top_pct <- params$windy_top_pct
windy_threshold_ms <- params$windy_threshold_ms
window_days <- params$window_days

# --- Safe vars: only keep variables that exist in ref + ALL targets (prevents render errors) ---
vars_requested <- params$vars
vars_available <- Reduce(
  intersect,
  c(list(names(ref_df)), lapply(targets_list, names))
)
vars <- intersect(vars_requested, vars_available)

vars
```

## Data coverage

```{r}
#| echo: false
coverage <- bind_rows(
  Reference = ref_df,
  !!!targets_list,
  .id = "Dataset"
) |>
  group_by(Dataset) |>
  summarise(
    first_date = min(Date, na.rm = TRUE),
    last_date  = max(Date, na.rm = TRUE),
    n_days     = sum(!is.na(Date)),
    .groups = "drop"
  )

reactable(
  coverage,
  sortable = TRUE,
  striped = TRUE,
  pagination = FALSE
)
```

## Metrics table (reference vs targets)

```{r}
#| echo: false
metrics_all <- purrr::imap_dfr(
  targets_list,
  ~ metrics_vs_ref(
    ref_df      = ref_df,
    target_df   = .x,
    target_name = .y,
    vars = vars,
    wet_threshold_mm = wet_threshold_mm,
    windy_threshold_ms = windy_threshold_ms,
    windy_top_pct = windy_top_pct
  )
)

reactable(
  metrics_all,
  searchable = TRUE,
  sortable = TRUE,
  highlight = TRUE,
  defaultPageSize = 12
)
```

## Time series overlays

```{r}
plot_timeseries_line(ref_df, targets_list, "Temp_C")
```

```{r}
plot_timeseries_line(ref_df, targets_list, "Wind_Spd_ms")
```

```{r}
plot_timeseries_line(ref_df, targets_list, "Precip_mm")
```

```{r}
if ("RadSWD_Wm2" %in% vars) plot_timeseries_line(ref_df, targets_list, "RadSWD_Wm2")
```

## Precipitation event structure

```{r}
plot_precip_hydrograph(ref_df, targets_list, show_7day_sum = TRUE)
```

```{r}
plot_precip_cdf(ref_df, targets_list)
```

```{r}
plot_precip_wetday_distribution(ref_df, targets_list, threshold_mm = wet_threshold_mm)
```

## Distribution (variability / bias)

```{r}
plot_distribution(ref_df, targets_list, "Temp_C")
```

```{r}
plot_distribution(ref_df, targets_list, "Wind_Spd_ms")
```

```{r}
plot_distribution(ref_df, targets_list, "Precip_mm")
```

## Scatter vs reference

```{r}
plot_scatter_faceted(ref_df, targets_list, "Temp_C", ncol = 2)
```

```{r}
plot_scatter_faceted(ref_df, targets_list, "Wind_Spd_ms", ncol = 2)
```

```{r}
plot_scatter_faceted(ref_df, targets_list, "Precip_mm", ncol = 2)
```

```{r}
if ("RadSWD_Wm2" %in% vars) plot_scatter_faceted(ref_df, targets_list, "RadSWD_Wm2", ncol = 2)
```

## Rolling diagnostics (drift thrugh time)

```{r}
purrr::iwalk(targets_list, ~ print(plot_rolling_diagnostics(ref_df, .x, .y, "Temp_C", window_days = window_days)))
```

```{r}
purrr::iwalk(targets_list, ~ print(plot_rolling_diagnostics(ref_df, .x, .y, "Wind_Spd_ms", window_days = window_days)))
```

```{r}
purrr::iwalk(targets_list, ~ print(plot_rolling_diagnostics(ref_df, .x, .y, "Precip_mm", window_days = window_days)))
```

## Precipitation event agreement

```{r}
#| echo: false
skill_precip <- event_skill_all_targets(
  ref_df, targets_list,
  var = "Precip_mm",
  threshold = precip_event_threshold,
  direction = ">="
)

reactable(skill_precip, sortable = TRUE, striped = TRUE)
```

```{r}
plot_event_outcomes(
  skill_precip,
  title = paste0("Precip events (≥= ", precip_event_threshold, " mm/day): outcomes vs reference")
)
```

```{r}
plot_event_skill_scores(
  skill_precip,
  title = paste0("Precip events (≥= ", precip_event_threshold, " mm/day): skill vs reference")
)
```

```{r}
plot_false_alarm_magnitude(ref_df, targets_list, threshold_mm = precip_event_threshold)
```

## Monthly climatology (seasonal structure)

```{r}
plot_monthly_climatology(ref_df, targets_list, "Temp_C")
```

```{r}
plot_monthly_climatology(ref_df, targets_list, "Wind_Spd_ms")
```

```{r}
plot_monthly_climatology(ref_df, targets_list, "Precip_mm")
```

## Seasonal performance (NZ/Southern Hemisphere)

```{r}
season_defs <- season_defs_default
plot_seasonal_bias(ref_df, targets_list, "Temp_C", season_defs = season_defs)
```

```{r}
plot_seasonal_scatter(ref_df, targets_list, "Wind_Spd_ms", season_defs = season_defs)
```

```{r}
plot_seasonal_scatter(ref_df, targets_list, "Precip_mm", season_defs = season_defs)
```

## Interactive table

```{r}
latest_table <- map_dfr(
  setNames(c(params$reference, params$targets), c("Reference", params$targets)),
  function(name) {
    df <- read_from_map(name) |> filter(!is.na(Date))
    last_row <- slice_max(df, Date, n = 1, with_ties = FALSE)
    tibble(
      Dataset    = name,
      Date       = last_row$Date,
      Temp_C     = last_row$Temp_C,
      Precip_mm  = last_row$Precip_mm,
      Wind_Spd_ms= last_row$Wind_Spd_ms,
      RadSWD_Wm2 = last_row$RadSWD_Wm2
    )
  }
)

reactable(
  latest_table,
  searchable = TRUE,
  sortable = TRUE,
  pagination = TRUE,
  striped = TRUE,
  highlight = TRUE,
  defaultPageSize = 5
)
```